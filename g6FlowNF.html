<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>G6 Flow Demo</title>
    <style type="text/css">
      .container, .container1 {
        position: relative;
        overflow: hidden;
      }
      .g6-tooltip {
        padding: 10px 6px;
        color: #444;
        background-color: rgba(255, 255, 255, 0.8);
        border: 1px solid #e2e2e2;
        border-radius: 4px;
      }
      .tip-label{
        display: inline-block;
        text-align: end;
        width: 70px;
        margin-right: 10px;
      }
    </style>
  </head>
  <body>
    <div style="display: flex; justify-content: center;">
        <div style="border: 1px solid #aaa; width: 40%;padding: 5px;">
            <div>group flow(点击组节点可查看该组内任务流程进度)</div>
            <div id="container" class="container"></div>
        </div>
        <div id="groupInner" style="border: 1px solid #aaa;padding: 5px;display: none;">
            <div>group2 work flow</div>
            <div id="container1" class="container1"></div>
        </div>
    </div>

    <script src="./g6.min.js"></script>
    <script src="./jquery-3.7.1.min.js"></script>

    <script>
      const data = {
        nodes: [
          {
            id: "group1",
            label: "group1",
            status: 3 // 已结束
          },
          {
            id: "group2",
            label: "group2",
            status: 2 // 中断
          },
          {
            id: "group3",
            label: "group3",
            status: 3 // 已结束
          },
          {
            id: "group4",
            label: "group4",
            status: 3 // 已结束
          },
          {
            id: "group5",
            label: "group5",
            status: 1 // 进行中
          },
          {
            id: "group6",
            label: "group6",
            status: 0 // 未开始
          },
        ],
        edges: [
          { id: "edge1", source: "group1", target: "group2" },
          { id: "edge2", source: "group1", target: "group3" },
          { id: "edge3", source: "group2", target: "group4" },
          { id: "edge4", source: "group3", target: "group4" },
          { id: "edge5", source: "group4", target: "group5" },
          { id: "edge6", source: "group5", target: "group6" },
        ]
      };

      function getStatusByNumber(status) {
        switch (status) {
          case 1:
            return "进行中";
          case 2:
            return "已中断";
          case 3:
            return "已结束";
          default:
            return "未开始";
        }
      }

      // 根据节点的状态state字段赋予节点和边不同颜色
      function updateNodesStyleByStatus(data) {
        data.nodes.forEach((node) => {
            switch (node.status) {
              case 1: // 进行中
                  node.style = {
                    fill: "#99C0ED",
                    stroke: "#aaa",
                  };
                  node.stateStyles = {
                    active: {
                      fill: "#99C0ED",
                      stroke: "#eee",
                    },
                    selected: {
                      fill: "#99C0ED",
                      stroke: "#eee",
                    }
                  };
                  break;
              case 2: // 异常or中断
                  node.style = {
                    fill: "#e03131",
                    stroke: "#aaa",
                  };
                  node.stateStyles = {
                    active: {
                      fill: "#e03131",
                      stroke: "#eee",
                    },
                    selected: {
                      fill: "#e03131",
                      stroke: "#eee",
                    }
                  };
                  break;
                case 3: // 已结束
                node.style = {
                  fill: "#C4E3B2",
                  stroke: "#aaa",
                };
                node.stateStyles = {
                  active: {
                    fill: "#C4E3B2",
                    stroke: "#eee",
                  },
                  selected: {
                    fill: "#C4E3B2",
                    stroke: "#eee",
                  }
                };
                break;
              default: // 未开始或者其他
                  node.style = {
                  fill: "#eee",
                  stroke: "#aaa",
                  };
                  node.stateStyles = {
                    active: {
                      fill: "#eee",
                      stroke: "#eee",
                    },
                    selected: {
                      fill: "#eee",
                      stroke: "#eee",
                    }
                  };
                  break;
            }
        });
      }
      updateNodesStyleByStatus(data);

      const width = document.getElementById("container").scrollWidth || 500;
      const height = document.getElementById("container").scrollHeight || 500;
      const fixSelectedItems = {
        fixAll: true,
        fixState: 'myState', // 'selected' by default
      };
      const graph = new G6.Graph({
        container: "container",
        width,
        height,
        fitCenter: true,
        groupByTypes: false,
        modes: {
          default: [
            "drag-canvas",
            "drag-node",
            {
                type: 'zoom-canvas',
                fixSelectedItems,
            },
            {
              type: 'tooltip',
              formatText(model) {
                const html = `
                  <div>
                    <div><span class='tip-label'>组Id: </span><span class='tip-value'>${model.id}</span></div>
                    <div><span class='tip-label'>组名称: </span><span class='tip-value'>${model.label}</span></div>
                    <div><span class='tip-label'>组状态: </span><span class='tip-value'>${getStatusByNumber(model.status)}</span></div>
                  </div>
                `;
                return html;
              },
              offset: 0,
            }
          ],
        },
        layout: {
            type: 'dagre',
            ranksep: 20,
            nodesep: 20,
            rankdir: 'LR', // 从左到右布局
        },
        defaultNode: {
          type: "circle",
          style: {
            r: 30,
            fill: "#fff",
            stroke: "#aaa",
            lineWidth: 1,
            cursor: 'pointer',
          },
        },
        defaultEdge: {
          style: {
            color: "#fff",
            endArrow: true,
            // stroke: "#FF6107",
            stroke: "#8CC2FC",
            lineWidth: 1,
            opacity: 0.6,
          },
        }
      });

      graph.data(data);
      graph.render();

      graph.on("node:mouseenter", (evt) => {
        const { item } = evt;
        graph.setItemState(item, "active", true);
      });

      graph.on("node:mouseleave", (evt) => {
        const { item } = evt;
        graph.setItemState(item, "active", false);
      });
      graph.on("node:click", (evt) => {
        const { item } = evt;
        graph.getNodes().forEach((node) => {
          graph.clearItemStates(node);
        });
        graph.setItemState(item, "selected", true);
      });
      graph.on("canvas:click", (evt) => {
        graph.getNodes().forEach((node) => {
          graph.clearItemStates(node);
        });
      });

      var graph1 = null // 用于组内批任务canvas对象存储
      

      function getDataByGroupID(groupId) {
        return data1 = {
            groupId: groupId,
            nodes: [
            {
                id: "node1",
                label: "任务1",
                status: 3 // 已结束
            },
            {
                id: "node2",
                label: "任务2",
                status: 2 // 中断
            },
            {
                id: "node3",
                label: "任务3",
                status: 3 // 已结束
            },
            {
                id: "node4",
                label: "任务4",
                status: 3 // 已结束
            },
            {
                id: "node5",
                label: "任务5",
                status: 1 // 进行中
            },
            {
                id: "node6",
                label: "任务6",
                status: 0 // 未开始
            },
            {
                id: "node7",
                label: "任务7",
                status: 0 // 未开始
            },
            {
                id: "node8",
                label: "任务8",
                status: 0 // 未开始
            },
            ],
            edges: [
            { id: "edge1", source: "node1", target: "node2" },
            { id: "edge2", source: "node1", target: "node3" },
            { id: "edge3", source: "node2", target: "node4" },
            { id: "edge4", source: "node3", target: "node4" },
            { id: "edge5", source: "node4", target: "node5" },
            { id: "edge6", source: "node5", target: "node6" },
            { id: "edge7", source: "node5", target: "node7" },
            { id: "edge8", source: "node6", target: "node8" },
            { id: "edge9", source: "node7", target: "node8" },
            ]
        };
      }

        
      graph.on("node:click", (evt) => {
        const { item } = evt;
        let groupId = item._cfg.id
        if(graph1) {
            graph1.destroy();
        }
        graph1 = new G6.Graph({
            container: "container1",
            width: 800,
            height: 500,
            fitCenter: true,
            groupByTypes: false,
            modes: {
            default: [
                "drag-canvas",
                "drag-node",
                {
                    type: 'zoom-canvas',
                    fixSelectedItems,
                },
                {
                  type: 'tooltip',
                  formatText(model) {
                    const html = `
                      <div>
                        <div><span class='tip-label'>任务Id: </span><span class='tip-value'>${model.id}</span></div>
                        <div><span class='tip-label'>任务名称: </span><span class='tip-value'>${model.label}</span></div>
                        <div><span class='tip-label'>任务状态: </span><span class='tip-value'>${getStatusByNumber(model.status)}</span></div>
                      </div>
                    `;
                    return html;
                  },
                  offset: 0,
                }
            ],
            },
            layout: {
                type: 'dagre',
                ranksep: 20,
                nodesep: 20,
                rankdir: 'LR', // 从左到右布局
            },
            defaultNode: {
                type: "circle",
                style: {
                    r: 30,
                    fill: "#fff",
                    stroke: "#aaa",
                    lineWidth: 1,
                    cursor: 'pointer',
                },
            },
            defaultEdge: {
                style: {
                    color: "#fff",
                    endArrow: true,
                    // stroke: "#FF6107",
                    stroke: "#8CC2FC",
                    lineWidth: 1,
                    opacity: 0.6,
                },
            }
        });
        let data1 = getDataByGroupID(groupId)
        updateNodesStyleByStatus(data1);

        graph1.data(data1);
        graph1.render();
        graph1.on("node:mouseenter", (evt) => {
          const { item } = evt;
          graph.setItemState(item, "active", true);
        });

        graph1.on("node:mouseleave", (evt) => {
          const { item } = evt;
          graph.setItemState(item, "active", false);
        });
        $("#groupInner").find("div:first").text(groupId);
        $("#groupInner").show();
      });
    </script>
  </body>
</html>
